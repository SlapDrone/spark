---
# tasks file for pyenv role

- name: Install dependencies for pyenv
  become: true
  pacman:
    state: present
    name:
      - base-devel
      - openssl
      - zlib
      - readline
      - tk

- name: Download and run pyenv installer
  become: true
  become_user: "{{ user.name }}"
  ansible.builtin.shell: |
    curl https://pyenv.run | bash
  args:
    creates: "/home/{{ user.name }}/.pyenv"

- name: Add pyenv init and configuration to profile files
  become: true
  become_user: "{{ user.name }}"
  ansible.builtin.blockinfile:
    path: "{{ item }}"
    block: |
      export ZSH_PYENV_QUIET=true
      export PYENV_ROOT="/home/{{ user.name }}/.pyenv"
      command -v pyenv >/dev/null || export PATH="$PYENV_ROOT/bin:$PATH"
      eval "$(pyenv init --path)"
      eval "$(pyenv init -)"
      export PYTHON_BUILD_ARIA2_OPTS="-d $PYENV_ROOT/cache"
    create: yes
    state: present
    insertbefore: BOF
  loop:
    - "/home/{{ user.name }}/.zshrc"
    - "/home/{{ user.name }}/.bashrc"
    - "/home/{{ user.name }}/.zprofile"
    - "/home/{{ user.name }}/.profile"

- name: Ensure zsh is the default shell
  become: true
  ansible.builtin.user:
    name: "{{ user.name }}"
    shell: /bin/zsh

